#!/usr/bin/env bash
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ Releasing skinny_includes${NC}"
echo ""

# Run tests first
echo -e "${YELLOW}üß™ Running tests...${NC}"
if bundle exec rspec > /dev/null 2>&1; then
  echo -e "${GREEN}‚úì All tests passed${NC}"
else
  echo -e "${RED}‚ùå Tests failed${NC}"
  exit 1
fi

# Get current version
CURRENT_VERSION=$(ruby -r ./lib/skinny_includes/version.rb -e "puts SkinnyIncludes::VERSION")
echo ""
echo -e "${YELLOW}üì¶ Current version: ${CURRENT_VERSION}${NC}"

# Bump version by 0.1
NEW_VERSION=$(ruby -e "
  version = '${CURRENT_VERSION}'.split('.').map(&:to_i)
  version[1] += 1
  puts version.join('.')
")

echo -e "${YELLOW}üì¶ New version: ${NEW_VERSION}${NC}"
echo ""

# Update version file
VERSION_FILE="lib/skinny_includes/version.rb"
sed -i '' "s/VERSION = \"${CURRENT_VERSION}\"/VERSION = \"${NEW_VERSION}\"/" "$VERSION_FILE"
echo -e "${GREEN}‚úì Updated version to ${NEW_VERSION}${NC}"

# Run bundle
echo ""
echo -e "${YELLOW}üì¶ Running bundle...${NC}"
bundle
echo -e "${GREEN}‚úì Bundle complete${NC}"

# Check if git is clean (excluding version file and Gemfile.lock)
CHANGED_FILES=$(git status -s | grep -v "lib/skinny_includes/version.rb" | grep -v "Gemfile.lock" || true)
if [[ -n "$CHANGED_FILES" ]]; then
  echo -e "${RED}‚ùå Git working directory has unexpected changes. Commit or stash changes first.${NC}"
  echo "$CHANGED_FILES"
  # Revert version change
  git checkout "$VERSION_FILE"
  exit 1
fi

echo -e "${GREEN}‚úì Git working directory is clean${NC}"

# Check if version tag already exists
if git rev-parse "v${NEW_VERSION}" >/dev/null 2>&1; then
  echo -e "${RED}‚ùå Git tag v${NEW_VERSION} already exists.${NC}"
  # Revert version change
  git checkout "$VERSION_FILE"
  exit 1
fi

echo -e "${GREEN}‚úì Version tag doesn't exist yet${NC}"

# Build gem
GEM_FILE="skinny_includes-${NEW_VERSION}.gem"
echo ""
echo -e "${YELLOW}üî® Building gem...${NC}"
gem build skinny_includes.gemspec

if [[ ! -f "$GEM_FILE" ]]; then
  echo -e "${RED}‚ùå Gem file not found: ${GEM_FILE}${NC}"
  # Revert version change
  git checkout "$VERSION_FILE"
  exit 1
fi

echo -e "${GREEN}‚úì Built ${GEM_FILE}${NC}"

# Show what will be included
echo ""
echo -e "${YELLOW}üìã Files included in gem:${NC}"
gem spec "$GEM_FILE" files | head -20
echo "..."

# Confirm release
echo ""
echo -e "${YELLOW}Ready to:${NC}"
echo "  1. Commit version bump (${CURRENT_VERSION} ‚Üí ${NEW_VERSION})"
echo "  2. Push gem to rubygems.org"
echo "  3. Create git tag v${NEW_VERSION}"
echo "  4. Push to GitHub"
echo ""
read -p "Continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${RED}Aborted${NC}"
  rm -f "$GEM_FILE"
  # Revert version change
  git checkout "$VERSION_FILE"
  git checkout "Gemfile.lock"
  exit 1
fi

# Commit version bump
echo ""
echo -e "${YELLOW}üìù Committing version bump...${NC}"
git add "$VERSION_FILE" "Gemfile.lock"
git commit -m "Bump version to ${NEW_VERSION}"
echo -e "${GREEN}‚úì Committed version bump${NC}"

# Push to rubygems
echo ""
echo -e "${YELLOW}üì§ Pushing to rubygems.org...${NC}"
gem push "$GEM_FILE"

if [[ $? -ne 0 ]]; then
  echo -e "${RED}‚ùå Failed to push gem${NC}"
  rm -f "$GEM_FILE"
  exit 1
fi

echo -e "${GREEN}‚úì Pushed to rubygems.org${NC}"

# Create and push git tag
echo ""
echo -e "${YELLOW}üè∑Ô∏è  Creating git tag...${NC}"
git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"

echo -e "${YELLOW}üì§ Pushing to GitHub...${NC}"
git push origin main
git push origin "v${NEW_VERSION}"

echo -e "${GREEN}‚úì Pushed to GitHub${NC}"

# Cleanup
rm -f "$GEM_FILE"

echo ""
echo -e "${GREEN}üéâ Successfully released skinny_includes v${NEW_VERSION}${NC}"
echo ""
echo "View at: https://rubygems.org/gems/skinny_includes"
echo "Install: gem install skinny_includes"
